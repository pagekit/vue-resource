/**
 * Utility functions.
 */

(function() {
    var _ = {};

    if (_ && _.config) {
        return module.exports = _;
    }

    module.exports = function(Vue) {
        var array = [], console = window.console;

        _.config = Vue.config;
        _.warning = Vue.util.warn;
        _.nextTick = Vue.util.nextTick;

        _.warn = (console && _.warning && (!_.config.silent || _.config.debug))
            ? Function.bind.call(console.warn, console, '[VueResource warn]: ')
            : _.warn = function () {}

        _.error = (console)
            ? Function.bind.call(console.error, console)
            : _.error = function() {}

        _.trim = function (str) {
            return str.replace(/^\s*|\s*$/g, '');
        };

        _.toLower = function (str) {
            return str ? str.toLowerCase() : '';
        };

        _.isArray = Array.isArray;

        _.isString = function (val) {
            return typeof val === 'string';
        };

        _.isFunction = function (val) {
            return typeof val === 'function';
        };

        _.isObject = function (obj) {
            return obj !== null && typeof obj === 'object';
        };

        _.isPlainObject = function (obj) {
            return _.isObject(obj) && Object.getPrototypeOf(obj) == Object.prototype;
        };

        _.options = function (fn, obj, options) {

            options = options || {};

            if (_.isFunction(options)) {
                options = options.call(obj);
            }

            return _.merge(fn.bind({$vm: obj, $options: options}), fn, {$options: options});
        };

        _.each = function (obj, iterator) {

            var i, key;

            if (typeof obj.length == 'number') {
                for (i = 0; i < obj.length; i++) {
                    iterator.call(obj[i], obj[i], i);
                }
            } else if (_.isObject(obj)) {
                for (key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        iterator.call(obj[key], obj[key], key);
                    }
                }
            }

            return obj;
        };

        _.defaults = function (target, source) {

            for (var key in source) {
                if (target[key] === undefined) {
                    target[key] = source[key];
                }
            }

            return target;
        };

        _.extend = function (target) {

            var args = array.slice.call(arguments, 1);

            args.forEach(function (arg) {
                merge(target, arg);
            });

            return target;
        };

        _.merge = function (target) {

            var args = array.slice.call(arguments, 1);

            args.forEach(function (arg) {
                merge(target, arg, true);
            });

            return target;
        };

        function merge(target, source, deep) {
            for (var key in source) {
                if (deep && (_.isPlainObject(source[key]) || _.isArray(source[key]))) {
                    if (_.isPlainObject(source[key]) && !_.isPlainObject(target[key])) {
                        target[key] = {};
                    }
                    if (_.isArray(source[key]) && !_.isArray(target[key])) {
                        target[key] = [];
                    }
                    merge(target[key], source[key], deep);
                } else if (source[key] !== undefined) {
                    target[key] = source[key];
                }
            }
        }

        module.exports = _;
        return _;
    }
})()
